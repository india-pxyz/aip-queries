DECLARE START_TIMESTAMP TIMESTAMP DEFAULT '2022-06-20T00:00:00';
DECLARE END_TIMESTAMP TIMESTAMP DEFAULT '2022-06-22T00:00:00';
DECLARE CAMPAIGN_IDS ARRAY<STRING> DEFAULT [
    /* Returns all campaigns if array is empty */
  -- '7277694', -- macro_campaign_id
  -- '05061f30-b0b1-11ec-a3d8-6d2522df3298' -- static_campaign_id
];

SELECT
  --imps.day_partition,
  imps.impression_id,
  imps.impression_timestamp,
  imps.referrer_domain,
  imps.referrer_url,
  imps.geo_continent,
  imps.geo_country,
  imps.geo_city,
  imps.geo_state,
  imps.geo_postal_code,
  imps.device_platform,
  imps.device_vendor,
  imps.device_model,
  imps.device_os,
  imps.device_browser,
  imps.device_user_agent,
  imps.window_width,
  imps.window_height,
  imps.viewport_width,
  imps.viewport_height,
  imps.ad_width,
  imps.ad_height,
  imps.ad_rich_media_vendor,
  imps.ad_format,
  imps.ad_part,
  imps.ad_total_parts,
  imps.gaze_model_version,
  imps.scored_batch_timestamp,
  imps.predicted_attention,
  imps.attention_is_eligible,
  imps.attention_ineligible_reason,
  imps.amt_version,
  imps.tag_id,
  imps.tag_platform,
  imps.tag_label,
  imps.tag_code,
  imps.tag_is_overridden,
  imps.tag_sample_rate,
  imps.tag_mode,
  imps.tag_has_page_access,
  imps.macro_advertiser_id,
  imps.macro_campaign_id,
  imps.macro_creative_id,
  imps.macro_site_id,
  imps.macro_ad_id,
  imps.macro_placement_id,
  imps.macro_deal_id,
  imps.macro_impression_id,
  imps.static_organisation_id,
  imps.static_campaign_id,
  imps.static_line_item_id,
  imps.static_creative_id,
  imps.xandr_uid,
  imps.browser_language,
  display.time_local_day_of_week,
  display.time_local_day_part,
  display.time_local_hour,
  display.page_engagement_time,
  display.rtiv_in_view,
  display.rtiv_position,
  display.rtiv_segments_horizontal_0,
  display.rtiv_segments_horizontal_1,
  display.rtiv_segments_horizontal_2,
  display.rtiv_segments_horizontal_3,
  display.rtiv_segments_horizontal_4,
  display.rtiv_segments_horizontal_5,
  display.rtiv_segments_horizontal_6,
  display.rtiv_segments_horizontal_7,
  display.rtiv_segments_vertical_0,
  display.rtiv_segments_vertical_1,
  display.rtiv_segments_vertical_2,
  display.rtiv_segments_vertical_3,
  display.rtiv_segments_vertical_4,
  display.rtiv_segments_vertical_5,
  display.rtiv_segments_vertical_6,
  display.rtiv_segments_vertical_7,
  display.ee_entry_exit_ratio,
  display.ee_entry_time,
  display.ee_exit_time,
  display.total_direction_changes_on_exit,
  display.viewability_time_in_view_100,
  display.viewability_time_in_view_75,
  display.viewability_time_in_view_absolute,
  display.viewability_time_in_view_iab,
  display.viewability_is_viewable_iab
FROM `decoupled-attention.business_access_aip.v_impression_daily` imps
JOIN `decoupled-attention.business_access_aip.v_features_display_hourly` display USING(impression_id)
WHERE 
  (DATE(imps.day_partition) BETWEEN DATE(START_TIMESTAMP) AND DATE(END_TIMESTAMP))
  AND display.hour_partition BETWEEN START_TIMESTAMP AND END_TIMESTAMP
  AND IF(ARRAY_LENGTH(CAMPAIGN_IDS) > 0, imps.static_campaign_id IN UNNEST(CAMPAIGN_IDS) OR macro_campaign_id IN UNNEST(CAMPAIGN_IDS), TRUE)
